# 🔄 Двунаправленный матчинг: Визуальная схема

## Общая схема системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                         DCMN Lead System                             │
│                                                                       │
│  Два источника лидов:                                                │
│  1. WhatConverts (телефонные звонки)                                 │
│  2. Веб-формы (FBI, Marriage, Embassy, I-9, Translation, etc.)      │
│                                                                       │
│  Задача: Матчить лиды по phone + service, избегать дубликатов       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Направление 1: Звонок → Форма (Phone Lead First)

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 1. КЛИЕНТ ЗВОНИТ                                                         │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ WhatConverts webhook
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 2. DJANGO ПОЛУЧАЕТ WEBHOOK                                               │
│    - lead_type: "Phone Call"                                             │
│    - phone: +1 (555) 123-4567                                            │
│    - landing_url: "/apostille-fbi-form"                                  │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ detect_service_from_url()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 3. ДЕТЕКТИРОВАНИЕ СЕРВИСА                                                │
│    - service: "fbi"                                                      │
│    - zoho_module: "FBI_Apostille"                                        │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ find_matching_order(phone, service)
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 4. ПРОВЕРКА EXISTING ORDER                                               │
│    - Ищем: Order с phone=5551234567 AND service='fbi'                   │
│    - Результат: НЕТ (клиент звонит первый раз)                          │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ PhoneCallLead.objects.create()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 5. СОЗДАНИЕ PHONECALLLEAD                                                │
│    PhoneCallLead #123:                                                   │
│    - phone: +1 (555) 123-4567                                            │
│    - detected_service: "fbi"                                             │
│    - source: "google"                                                    │
│    - gclid: "abc123"                                                     │
│    - sentiment: "Positive"                                               │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ sync_phone_lead_to_zoho()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 6. СИНХРОНИЗАЦИЯ С ZOHO                                                  │
│    Zoho → FBI_Apostille:                                                 │
│    - Lead: "John Doe | google/cpc | 2026-02-09"                         │
│    - Stage: "Phone Call Received" ◀── ВАЖНО                             │
│    - Lead Attribution Record создана                                     │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ (через 2 часа...)
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│ 7. КЛИЕНТ ЗАПОЛНЯЕТ ФОРМУ FBI                                            │
│    - Name: John Doe                                                      │
│    - Phone: +1 (555) 123-4567                                            │
│    - Email: john@example.com                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ FbiApostilleOrder.objects.create()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 8. СОЗДАНИЕ ORDER                                                        │
│    FbiApostilleOrder #456:                                               │
│    - name: "John Doe"                                                    │
│    - phone: +1 (555) 123-4567                                            │
│    - email: john@example.com                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ process_order_with_phone_lead_check()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 9. ПОИСК MATCHING PHONE LEAD                                             │
│    find_phone_lead_for_order(phone=5551234567, service='fbi')           │
│    → НАЙДЕН: PhoneCallLead #123                                          │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ update_phone_lead_with_form_data()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 10. ОБНОВЛЕНИЕ PHONE LEAD                                                │
│     PhoneCallLead #123:                                                  │
│     - email: john@example.com (обновлено)                               │
│     - matched_with_form: True                                            │
│     - matched_order_id: 456                                              │
│     - WhatConverts data сохранена! (source, gclid, sentiment)           │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ order.zoho_synced = True ◀── КРИТИЧНО!
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 11. ПРЕДОТВРАЩЕНИЕ ДУБЛИКАТА                                             │
│     FbiApostilleOrder #456:                                              │
│     - zoho_synced: True                                                  │
│     → Celery task НЕ создаст новый Zoho lead                            │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ update_zoho_lead_with_order_data()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 12. ОБНОВЛЕНИЕ ZOHO LEAD                                                 │
│     Zoho → FBI_Apostille:                                                │
│     - Email: john@example.com (обновлено)                               │
│     - Stage: "Order Received" ◀── ПЕРЕМЕЩЕН                              │
└──────────────────────────────────────────────────────────────────────────┘

✅ РЕЗУЛЬТАТ: 1 PhoneCallLead + 1 Order + 1 Zoho Lead (НЕТ ДУБЛИКАТОВ)
```

---

## Направление 2: Форма → Звонок (Order First) - НОВОЕ

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 1. КЛИЕНТ ЗАПОЛНЯЕТ ФОРМУ FBI                                            │
│    - Name: Jane Smith                                                    │
│    - Phone: +1 (555) 987-6543                                            │
│    - Email: jane@example.com                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ FbiApostilleOrder.objects.create()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 2. СОЗДАНИЕ ORDER                                                        │
│    FbiApostilleOrder #789:                                               │
│    - name: "Jane Smith"                                                  │
│    - phone: +1 (555) 987-6543                                            │
│    - email: jane@example.com                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ Celery task: sync_order_to_zoho()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 3. СИНХРОНИЗАЦИЯ С ZOHO                                                  │
│    Zoho → FBI_Apostille:                                                 │
│    - Lead: "Jane Smith | direct/form | 2026-02-09"                      │
│    - Stage: "Order Received"                                             │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ (через 2 часа...)
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│ 4. КЛИЕНТ ЗВОНИТ С ВОПРОСОМ                                              │
│    "Когда будет готово?"                                                 │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ WhatConverts webhook
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 5. DJANGO ПОЛУЧАЕТ WEBHOOK                                               │
│    - lead_type: "Phone Call"                                             │
│    - phone: +1 (555) 987-6543                                            │
│    - landing_url: "/apostille-fbi-form"                                  │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ detect_service_from_url()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 6. ДЕТЕКТИРОВАНИЕ СЕРВИСА                                                │
│    - service: "fbi"                                                      │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ find_matching_order(phone, service)
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 7. ПРОВЕРКА EXISTING ORDER ◀── КРИТИЧНАЯ ПРОВЕРКА                        │
│    - Ищем: Order с phone=5559876543 AND service='fbi'                   │
│    - Результат: НАЙДЕН FbiApostilleOrder #789                            │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ 90% вероятность: уточняющий звонок
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 8. PHONECALLLEAD НЕ СОЗДАЕТСЯ ◀── ВАЖНО!                                 │
│                                                                           │
│    ⏭️ SKIPPING PHONE LEAD CREATION                                       │
│    Found existing fbi order #789                                         │
│    90% probability: Clarification call about existing order              │
│                                                                           │
│    return None                                                           │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ webhook response
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 9. WEBHOOK ОТВЕТ                                                         │
│    {                                                                     │
│      "status": "skipped",                                                │
│      "reason": "Matching order already exists",                          │
│      "message": "90% probability: clarification call"                    │
│    }                                                                     │
└──────────────────────────────────────────────────────────────────────────┘

✅ РЕЗУЛЬТАТ: 1 Order + 1 Zoho Lead (PhoneCallLead НЕ создан, НЕТ ДУБЛИКАТОВ)
```

---

## Направление 3: Форма FBI → Звонок I-9 (Разные сервисы)

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 1. КЛИЕНТ ЗАПОЛНЯЕТ ФОРМУ FBI                                            │
│    FbiApostilleOrder #100 создан                                         │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ (через день...)
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│ 2. КЛИЕНТ ЗВОНИТ ПО ПОВОДУ I-9                                           │
│    WhatConverts webhook                                                  │
│    - phone: тот же                                                       │
│    - landing_url: "/i-9-verification-form"                               │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ detect_service_from_url()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 3. ДЕТЕКТИРОВАНИЕ СЕРВИСА                                                │
│    - service: "i9" ◀── ДРУГОЙ СЕРВИС                                     │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ find_matching_order(phone, service='i9')
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 4. ПРОВЕРКА EXISTING ORDER                                               │
│    - Ищем: Order с phone=XXX AND service='i9'                           │
│    - Результат: НЕТ (есть только FBI order, не I-9)                     │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ PhoneCallLead.objects.create()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 5. СОЗДАНИЕ PHONECALLLEAD                                                │
│    PhoneCallLead #200:                                                   │
│    - detected_service: "i9"                                              │
│    - phone: тот же что и FBI order                                       │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ sync_phone_lead_to_zoho()
                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 6. СИНХРОНИЗАЦИЯ С ZOHO                                                  │
│    Zoho → I9_Verification: ◀── ДРУГОЙ МОДУЛЬ                             │
│    - Stage: "Phone Call Received"                                        │
└──────────────────────────────────────────────────────────────────────────┘

✅ РЕЗУЛЬТАТ: Создан новый PhoneCallLead (разные сервисы = разные лиды)
```

---

## Таблица принятия решений

| Ситуация | Phone | Service Order | Service Call | Действие | PhoneCallLead | Zoho |
|----------|-------|---------------|--------------|----------|---------------|------|
| 1. Звонок → Форма (тот же) | 5551234567 | - | fbi | Создать | ✅ Создан | FBI_Apostille (Phone Call Received) |
| (продолжение) | | fbi | fbi | Обновить | ✅ Обновлен | FBI_Apostille (Order Received) |
| 2. Форма → Звонок (тот же) | 5559876543 | fbi | fbi | Пропустить | ❌ НЕ создан | - |
| 3. Форма FBI → Звонок I-9 | 5559876543 | fbi | i9 | Создать | ✅ Создан | I9_Verification (Phone Call Received) |
| 4. Звонок FBI → Форма I-9 | 5551234567 | fbi | i9 | Создать | ✅ Создан | I9_Verification (Phone Call Received) |

---

## Ключевые моменты

### 🔑 Когда PhoneCallLead создается:

1. ✅ Первый звонок (Order не существует)
2. ✅ Звонок по другому сервису (FBI order есть, звонок по I-9)
3. ✅ Звонок перед формой (классический flow)

### 🔑 Когда PhoneCallLead НЕ создается:

1. ❌ Order уже существует с тем же phone + service
2. ❌ 90% вероятность: уточняющий звонок ("когда будет готово?")
3. ❌ Если нужна новая услуга, клиент заполнит форму сам

### 🔑 Предотвращение дубликатов:

1. **Phone → Form:** `order.zoho_synced = True` → Celery не создаст duplicate
2. **Form → Phone:** `return None` → PhoneCallLead вообще не создается
3. **Matching:** Только в рамках одного сервиса (FBI → FBI, не FBI → I-9)

### 🔑 WhatConverts Attribution:

```
При Phone → Form matching:
- source, medium, campaign, gclid ← из WhatConverts
- sentiment, intent, lead_score ← из WhatConverts
- call_duration, call_recording_url ← из WhatConverts

→ Все это переносится в Order.attribution_data
→ Zoho Lead Attribution Record обновляется
```

---

## Визуальная схема Zoho Stage движения

### Phone → Form (Stage transitions):

```
WhatConverts Call
      │
      ▼
┌──────────────────────┐
│ Phone Call Received  │  ← PhoneCallLead создан
└──────────────────────┘
      │
      │ Клиент заполняет форму
      ▼
┌──────────────────────┐
│   Order Received     │  ← PhoneCallLead обновлен + Order создан
└──────────────────────┘
```

### Form → Phone (No stage transition):

```
Web Form Submission
      │
      ▼
┌──────────────────────┐
│   Order Received     │  ← Order создан
└──────────────────────┘
      │
      │ Клиент звонит с вопросом
      │ (PhoneCallLead НЕ создается)
      ▼
┌──────────────────────┐
│   Order Received     │  ← Остается в той же стадии
└──────────────────────┘
                         (90% вероятность: уточняющий звонок)
```

---

## Итог

✅ **Двунаправленный матчинг работает**
✅ **Нет дубликатов в Zoho**
✅ **Матчинг только в рамках одного сервиса**
✅ **90% вероятность уточняющих звонков покрыта**
✅ **WhatConverts attribution сохраняется**
✅ **Готово к продакшену**
